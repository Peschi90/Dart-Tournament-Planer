<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UUID-System Test Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background: #5a6fd8;
        }
        .result-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .match-id-input {
            width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🆔 UUID-System Test Interface</h1>
        <p>Test interface for the new UUID-based match identification system</p>
    </div>

    <!-- API Status Tests -->
    <div class="test-section">
        <h2>📊 API Status Tests</h2>
        <button class="test-button" onclick="testApiHealth()">API Health Check</button>
        <button class="test-button" onclick="testTournamentList()">Tournament List</button>
        <button class="test-button" onclick="testWebSocketInfo()">WebSocket Info</button>
        <div id="api-results" class="result-box"></div>
    </div>

    <!-- UUID Match Tests -->
    <div class="test-section">
        <h2>🎯 UUID Match Tests</h2>
        <div>
            <input type="text" id="tournament-id" class="match-id-input" placeholder="Tournament ID" value="TOURNAMENT_20250827_145208">
            <input type="text" id="match-id" class="match-id-input" placeholder="Match ID (UUID or Numeric)" value="1">
            <button class="test-button" onclick="testMatchAccess()">Test Match Access</button>
            <button class="test-button" onclick="testMatchData()">Get Match Data</button>
            <button class="test-button" onclick="testMatchGameRules()">Get Game Rules</button>
        </div>
        <div id="match-results" class="result-box"></div>
    </div>

    <!-- Match Result Submission -->
    <div class="test-section">
        <h2>📤 Match Result Tests</h2>
        <div>
            <label>Tournament ID:</label><br>
            <input type="text" id="result-tournament-id" class="match-id-input" placeholder="Tournament ID" value="TOURNAMENT_20250827_145208"><br><br>
            
            <label>Match ID:</label><br>
            <input type="text" id="result-match-id" class="match-id-input" placeholder="Match ID (UUID or Numeric)" value="1"><br><br>
            
            <label>Player 1 Sets:</label>
            <input type="number" id="player1-sets" value="3" style="width: 60px;">
            <label>Player 1 Legs:</label>
            <input type="number" id="player1-legs" value="15" style="width: 60px;"><br><br>
            
            <label>Player 2 Sets:</label>
            <input type="number" id="player2-sets" value="1" style="width: 60px;">
            <label>Player 2 Legs:</label>
            <input type="number" id="player2-legs" value="8" style="width: 60px;"><br><br>
            
            <button class="test-button" onclick="testMatchResultSubmission()">Submit Result</button>
        </div>
        <div id="result-submission-results" class="result-box"></div>
    </div>

    <!-- Socket.IO Tests -->
    <div class="test-section">
        <h2>🔌 Socket.IO UUID Tests</h2>
        <button class="test-button" onclick="testSocketConnection()">Connect Socket</button>
        <button class="test-button" onclick="testMatchRoomJoin()">Join Match Room</button>
        <button class="test-button" onclick="testSocketDisconnect()">Disconnect</button>
        <div id="socket-results" class="result-box"></div>
    </div>

    <!-- Match-Page Tests -->
    <div class="test-section">
        <h2>📄 Match-Page Tests</h2>
        <div>
            <label>Tournament ID:</label><br>
            <input type="text" id="page-tournament-id" class="match-id-input" placeholder="Tournament ID" value="TOURNAMENT_20250827_145208"><br><br>
            
            <label>Match ID:</label><br>
            <input type="text" id="page-match-id" class="match-id-input" placeholder="Match ID (UUID or Numeric)" value="1"><br><br>
            
            <button class="test-button" onclick="testMatchPageOpen()">Open Match Page</button>
            <button class="test-button" onclick="testMatchPageModules()">Test Page Modules</button>
            <button class="test-button" onclick="testMatchPageAPI()">Test Page APIs</button>
        </div>
        <div id="match-page-results" class="result-box"></div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        const API_BASE = '';

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = type;
            element.innerHTML += `<span class="${typeClass}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        async function testApiHealth() {
            log('api-results', '🏥 Testing API Health...', 'info');
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                log('api-results', `✅ API Health: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                log('api-results', `❌ API Health Error: ${error.message}`, 'error');
            }
        }

        async function testTournamentList() {
            log('api-results', '🏆 Testing Tournament List...', 'info');
            try {
                const response = await fetch(`${API_BASE}/api/tournaments`);
                const data = await response.json();
                log('api-results', `✅ Tournaments: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                log('api-results', `❌ Tournament List Error: ${error.message}`, 'error');
            }
        }

        async function testWebSocketInfo() {
            log('api-results', '🔌 Testing WebSocket Info...', 'info');
            try {
                const response = await fetch(`${API_BASE}/api/websocket/info`);
                const data = await response.json();
                log('api-results', `✅ WebSocket Info: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                log('api-results', `❌ WebSocket Info Error: ${error.message}`, 'error');
            }
        }

        async function testMatchAccess() {
            const tournamentId = document.getElementById('tournament-id').value;
            const matchId = document.getElementById('match-id').value;
            
            log('match-results', `🔐 Testing Match Access: ${tournamentId}/${matchId}...`, 'info');
            try {
                const response = await fetch(`${API_BASE}/api/tournaments/${tournamentId}/matches/${matchId}/access`);
                const data = await response.json();
                log('match-results', `✅ Match Access: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                log('match-results', `❌ Match Access Error: ${error.message}`, 'error');
            }
        }

        async function testMatchData() {
            const tournamentId = document.getElementById('tournament-id').value;
            const matchId = document.getElementById('match-id').value;
            
            log('match-results', `📊 Testing Match Data: ${tournamentId}/${matchId}...`, 'info');
            try {
                const response = await fetch(`${API_BASE}/api/tournaments/${tournamentId}/matches/${matchId}`);
                const data = await response.json();
                log('match-results', `✅ Match Data: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                log('match-results', `❌ Match Data Error: ${error.message}`, 'error');
            }
        }

        async function testMatchGameRules() {
            const tournamentId = document.getElementById('tournament-id').value;
            const matchId = document.getElementById('match-id').value;
            
            log('match-results', `🎮 Testing Game Rules: ${tournamentId}/${matchId}...`, 'info');
            try {
                const response = await fetch(`${API_BASE}/api/tournaments/${tournamentId}/matches/${matchId}/rules`);
                const data = await response.json();
                log('match-results', `✅ Game Rules: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                log('match-results', `❌ Game Rules Error: ${error.message}`, 'error');
            }
        }

        async function testMatchResultSubmission() {
            const tournamentId = document.getElementById('result-tournament-id').value;
            const matchId = document.getElementById('result-match-id').value;
            const resultData = {
                player1Sets: parseInt(document.getElementById('player1-sets').value),
                player2Sets: parseInt(document.getElementById('player2-sets').value),
                player1Legs: parseInt(document.getElementById('player1-legs').value),
                player2Legs: parseInt(document.getElementById('player2-legs').value),
                status: 'Finished',
                notes: 'UUID System Test Result'
            };
            
            log('result-submission-results', `📤 Submitting Result: ${tournamentId}/${matchId}...`, 'info');
            log('result-submission-results', `📊 Data: ${JSON.stringify(resultData, null, 2)}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/tournaments/${tournamentId}/matches/${matchId}/result`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(resultData)
                });
                const data = await response.json();
                log('result-submission-results', `✅ Result Submitted: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                log('result-submission-results', `❌ Result Submission Error: ${error.message}`, 'error');
            }
        }

        function testSocketConnection() {
            log('socket-results', '🔌 Connecting to Socket.IO...', 'info');
            try {
                socket = io('/', {
                    transports: ['websocket', 'polling']
                });

                socket.on('connect', () => {
                    log('socket-results', `✅ Socket.IO Connected: ${socket.id}`, 'success');
                });

                socket.on('disconnect', (reason) => {
                    log('socket-results', `❌ Socket.IO Disconnected: ${reason}`, 'warning');
                });

                socket.on('connect_error', (error) => {
                    log('socket-results', `❌ Socket.IO Connection Error: ${error.message}`, 'error');
                });

                socket.on('match-room-joined', (data) => {
                    log('socket-results', `✅ Match Room Joined: ${JSON.stringify(data, null, 2)}`, 'success');
                });

                socket.on('match-room-error', (error) => {
                    log('socket-results', `❌ Match Room Error: ${JSON.stringify(error, null, 2)}`, 'error');
                });

                socket.on('match-updated', (data) => {
                    log('socket-results', `🔄 Match Updated: ${JSON.stringify(data, null, 2)}`, 'info');
                });

            } catch (error) {
                log('socket-results', `❌ Socket Connection Error: ${error.message}`, 'error');
            }
        }

        function testMatchRoomJoin() {
            if (!socket || !socket.connected) {
                log('socket-results', '❌ Socket not connected. Connect first!', 'error');
                return;
            }

            const tournamentId = document.getElementById('tournament-id').value;
            const matchId = document.getElementById('match-id').value;

            log('socket-results', `🎯 Joining Match Room: ${tournamentId}/${matchId}...`, 'info');
            
            socket.emit('join-match-room', {
                tournamentId: tournamentId,
                matchId: matchId,
                type: 'uuid-test'
            });
        }

        function testSocketDisconnect() {
            if (socket) {
                log('socket-results', '🔌 Disconnecting Socket.IO...', 'info');
                socket.disconnect();
                socket = null;
            }
        }

        function testMatchPageOpen() {
            const tournamentId = document.getElementById('page-tournament-id').value;
            const matchId = document.getElementById('page-match-id').value;
            
            log('match-page-results', `📄 Opening Match Page: ${tournamentId}/${matchId}...`, 'info');
            
            if (!tournamentId || !matchId) {
                log('match-page-results', '❌ Tournament ID und Match ID sind erforderlich', 'error');
                return;
            }
            
            const matchPageUrl = `/match-page.html?tournament=${tournamentId}&match=${matchId}`;
            log('match-page-results', `🔗 URL: ${matchPageUrl}`, 'info');
            
            try {
                const newWindow = window.open(matchPageUrl, '_blank', 'width=1200,height=800');
                if (newWindow) {
                    log('match-page-results', '✅ Match-Page in neuem Tab geöffnet', 'success');
                    log('match-page-results', '🔍 Überprüfen Sie die Browser-Konsole der neuen Seite auf Module-Loading', 'info');
                } else {
                    log('match-page-results', '⚠️ Popup wurde blockiert', 'warning');
                    window.location.href = matchPageUrl;
                }
            } catch (error) {
                log('match-page-results', `❌ Fehler beim Öffnen: ${error.message}`, 'error');
            }
        }

        async function testMatchPageModules() {
            log('match-page-results', '🔍 Testing Match-Page Module URLs...', 'info');
            
            const modules = [
                '/js/match-page-core.js',
                '/js/match-page-display.js', 
                '/js/match-page-scoring.js',
                '/js/match-page-api.js',
                '/js/match-page-main.js'
            ];
            
            for (const module of modules) {
                try {
                    const response = await fetch(module, { method: 'HEAD' });
                    if (response.ok) {
                        log('match-page-results', `✅ ${module} - erreichbar`, 'success');
                    } else {
                        log('match-page-results', `❌ ${module} - HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log('match-page-results', `❌ ${module} - ${error.message}`, 'error');
                }
            }
            
            // Test match-page.html
            try {
                const response = await fetch('/match-page.html', { method: 'HEAD' });
                if (response.ok) {
                    log('match-page-results', '✅ match-page.html - erreichbar', 'success');
                } else {
                    log('match-page-results', `❌ match-page.html - HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                log('match-page-results', `❌ match-page.html - ${error.message}`, 'error');
            }
        }

        async function testMatchPageAPI() {
            const tournamentId = document.getElementById('page-tournament-id').value;
            const matchId = document.getElementById('page-match-id').value;
            
            log('match-page-results', `📡 Testing Match-Page APIs: ${tournamentId}/${matchId}...`, 'info');
            
            // Test 1: Match Access
            try {
                const response = await fetch(`/api/tournaments/${tournamentId}/matches/${matchId}/access`);
                const data = await response.json();
                log('match-page-results', `✅ Match Access API: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                log('match-page-results', `❌ Match Access API Error: ${error.message}`, 'error');
            }
            
            // Test 2: Match Data
            try {
                const response = await fetch(`/api/tournaments/${tournamentId}/matches/${matchId}`);
                const data = await response.json();
                log('match-page-results', `✅ Match Data API: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                log('match-page-results', `❌ Match Data API Error: ${error.message}`, 'error');
            }
            
            // Test 3: Game Rules
            try {
                const response = await fetch(`/api/tournaments/${tournamentId}/matches/${matchId}/rules`);
                const data = await response.json();
                log('match-page-results', `✅ Game Rules API: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                log('match-page-results', `❌ Game Rules API Error: ${error.message}`, 'error');
            }
        }

        // Auto-connect and run initial tests on page load
        window.addEventListener('load', () => {
            log('api-results', '🚀 Enhanced UUID System Test Interface loaded', 'info');
            log('api-results', '✨ Features: Match-Page öffnen + Auto-Refresh nach Result-Submit', 'info');
            
            // Auto-run basic API tests
            setTimeout(async () => {
                log('api-results', '🔄 Running automatic initial tests...', 'info');
                
                await testApiHealth();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await testTournamentList();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await testWebSocketInfo();
                
                log('api-results', '✅ Initial tests complete! Enhanced system ready for testing.', 'success');
                log('api-results', '🎯 Neue Features:', 'info');
                log('api-results', '  📄 Match-Seiten öffnen aus Match-Cards', 'info');
                log('api-results', '  🔄 Auto-Refresh nach erfolgreichem Match-Result-Submit', 'info');
                log('api-results', '  🆔 UUID + Numerische ID Unterstützung', 'info');
            }, 1000);
        });
    </script>
</body>
</html>