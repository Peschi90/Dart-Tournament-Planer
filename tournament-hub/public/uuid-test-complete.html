<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UUID-System Test - Tournament Hub</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        .test-result {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { transform: translateY(-2px); }
        .uuid-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }
        .match-demo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .demo-match {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .demo-match.uuid { border-color: #28a745; }
        .demo-match.numeric { border-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>?? UUID-System Test</h1>
            <p>Test und Validierung des Tournament Hub UUID-Systems</p>
        </div>

        <div class="test-section">
            <h2>?? System-Tests</h2>
            <button onclick="runAllTests()">?? Alle Tests ausführen</button>
            <button onclick="testUuidGeneration()">?? UUID-Generierung testen</button>
            <button onclick="testMatchFinding()">?? Match-Suche testen</button>
            <button onclick="testApiIntegration()">?? API-Integration testen</button>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h2>?? Match-ID Test</h2>
            <p>Teste verschiedene Match-ID Formate:</p>
            <input type="text" class="uuid-input" id="testMatchId" 
                   placeholder="Match-ID eingeben (UUID oder numerisch)"
                   value="a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6">
            <br><br>
            <button onclick="analyzeMatchId()">?? ID analysieren</button>
            <button onclick="testMatchPageUrl()">?? Match-Page URL erstellen</button>
            <div id="idAnalysis"></div>
        </div>

        <div class="test-section">
            <h2>?? Demo Match Cards</h2>
            <div class="match-demo">
                <div class="demo-match uuid">
                    <h3>?? UUID Match</h3>
                    <div><strong>ID:</strong> <code>a1b2-c3d4-e5f6-g7h8</code></div>
                    <div><strong>Type:</strong> UUID (32+ chars, hyphens)</div>
                    <div><strong>Players:</strong> Alice vs Bob</div>
                    <button onclick="testUuidMatch()">?? Öffnen (UUID)</button>
                </div>
                <div class="demo-match numeric">
                    <h3>?? Numeric Match</h3>
                    <div><strong>ID:</strong> <code>123</code></div>
                    <div><strong>Type:</strong> Numeric (legacy)</div>
                    <div><strong>Players:</strong> Charlie vs Diana</div>
                    <button onclick="testNumericMatch()">?? Öffnen (Numeric)</button>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>?? Performance Test</h2>
            <button onclick="benchmarkUuidVsNumeric()">? UUID vs Numeric Performance</button>
            <button onclick="testLargeDataset()">?? Großer Datensatz Test</button>
            <div id="performanceResults"></div>
        </div>
    </div>

    <script>
        // Test-Daten
        const sampleMatches = [
            {
                matchId: 1,
                uniqueId: "a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6",
                player1: "Alice",
                player2: "Bob",
                status: "NotStarted"
            },
            {
                matchId: 2,
                uniqueId: "b2c3d4e5-f6g7-h8i9-j0k1-l2m3n4o5p6q7",
                player1: "Charlie",
                player2: "Diana",
                status: "InProgress"
            },
            {
                matchId: 3,
                uniqueId: null, // Legacy match ohne UUID
                player1: "Eve",
                player2: "Frank",
                status: "Finished"
            }
        ];

        // UUID-Generierung testen
        function testUuidGeneration() {
            const results = document.getElementById('testResults');
            results.innerHTML += '<div class="test-result info">?? UUID-Generierung Test...</div>';

            // Teste verschiedene UUID-Generierungsmethoden
            const uuid1 = generateUuid();
            const uuid2 = crypto.randomUUID ? crypto.randomUUID() : generateUuid();

            const isValidUuid = (uuid) => {
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
                return uuidRegex.test(uuid);
            };

            let testResult = '';
            testResult += `Generated UUID 1: ${uuid1} (Valid: ${isValidUuid(uuid1)})\n`;
            testResult += `Generated UUID 2: ${uuid2} (Valid: ${isValidUuid(uuid2)})\n`;
            testResult += `UUIDs are unique: ${uuid1 !== uuid2}\n`;
            testResult += `Browser crypto.randomUUID support: ${!!crypto.randomUUID}`;

            const status = isValidUuid(uuid1) && isValidUuid(uuid2) && uuid1 !== uuid2 ? 'success' : 'error';
            results.innerHTML += `<div class="test-result ${status}">${testResult}</div>`;
        }

        // Match-Suche testen
        function testMatchFinding() {
            const results = document.getElementById('testResults');
            results.innerHTML += '<div class="test-result info">?? Match-Suche Test...</div>';

            let testResult = '';
            
            // Test UUID-basierte Suche
            const match1 = findMatchByIdOrUUID(sampleMatches, "a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6");
            testResult += `UUID-Suche (Alice vs Bob): ${match1 ? '? Gefunden' : '? Nicht gefunden'}\n`;

            // Test numerische Suche
            const match2 = findMatchByIdOrUUID(sampleMatches, "2");
            testResult += `Numeric-Suche (Charlie vs Diana): ${match2 ? '? Gefunden' : '? Nicht gefunden'}\n`;

            // Test nicht existierende ID
            const match3 = findMatchByIdOrUUID(sampleMatches, "999");
            testResult += `Nicht existierende ID: ${match3 ? '? Falsch gefunden' : '? Korrekt nicht gefunden'}\n`;

            // Performance-Test
            const startTime = performance.now();
            for (let i = 0; i < 1000; i++) {
                findMatchByIdOrUUID(sampleMatches, "a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6");
            }
            const endTime = performance.now();
            testResult += `Performance: 1000 Suchen in ${(endTime - startTime).toFixed(2)}ms`;

            results.innerHTML += `<div class="test-result success">${testResult}</div>`;
        }

        // API-Integration testen
        async function testApiIntegration() {
            const results = document.getElementById('testResults');
            results.innerHTML += '<div class="test-result info">?? API-Integration Test...</div>';

            try {
                // Test Health-Check
                const healthResponse = await fetch('/api/health');
                const healthData = await healthResponse.json();
                
                let testResult = `Health-Check: ${healthResponse.ok ? '? OK' : '? Fehler'}\n`;
                testResult += `Server: ${healthData.server || 'Unknown'}\n`;
                testResult += `WebSocket Clients: ${healthData.websocket?.connectedClients || 0}\n`;

                // Test Tournament-Endpoint (falls verfügbar)
                try {
                    const tournamentsResponse = await fetch('/api/tournaments');
                    testResult += `Tournaments Endpoint: ${tournamentsResponse.ok ? '? OK' : '? Fehler'}\n`;
                } catch (e) {
                    testResult += `Tournaments Endpoint: ?? Nicht verfügbar\n`;
                }

                results.innerHTML += `<div class="test-result success">${testResult}</div>`;
            } catch (error) {
                results.innerHTML += `<div class="test-result error">? API-Test fehlgeschlagen: ${error.message}</div>`;
            }
        }

        // Match-ID analysieren
        function analyzeMatchId() {
            const matchId = document.getElementById('testMatchId').value;
            const analysis = document.getElementById('idAnalysis');

            const isLikelyUuid = matchId.length >= 32 && matchId.includes('-');
            const isNumeric = !isNaN(parseInt(matchId)) && !matchId.includes('-');
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            const isValidUuid = uuidRegex.test(matchId);

            let result = `?? Analyse für ID: "${matchId}"\n\n`;
            result += `Länge: ${matchId.length} Zeichen\n`;
            result += `Enthält Bindestriche: ${matchId.includes('-') ? 'Ja' : 'Nein'}\n`;
            result += `Ist numerisch: ${isNumeric ? 'Ja' : 'Nein'}\n`;
            result += `Ist wahrscheinlich UUID: ${isLikelyUuid ? 'Ja' : 'Nein'}\n`;
            result += `Ist gültige UUID: ${isValidUuid ? 'Ja' : 'Nein'}\n\n`;

            result += `Empfohlene Identifikations-Methode: ${isValidUuid || isLikelyUuid ? 'UUID' : 'Numeric'}\n`;
            result += `API-Kompatibilität: ${isValidUuid || isNumeric ? '? Kompatibel' : '?? Unbekanntes Format'}`;

            const statusClass = isValidUuid || isNumeric ? 'success' : 'warning';
            analysis.innerHTML = `<div class="test-result ${statusClass}">${result}</div>`;
        }

        // Match-Page URL erstellen
        function testMatchPageUrl() {
            const matchId = document.getElementById('testMatchId').value;
            const analysis = document.getElementById('idAnalysis');

            const isLikelyUuid = matchId.length >= 32 && matchId.includes('-');
            const tournamentId = 'TEST001';
            
            const matchPageUrl = `/match-page.html?tournament=${encodeURIComponent(tournamentId)}&match=${encodeURIComponent(matchId)}${isLikelyUuid ? '&uuid=true' : ''}`;

            let result = `?? Match-Page URL für "${matchId}":\n\n`;
            result += `URL: ${matchPageUrl}\n\n`;
            result += `URL-Parameter:\n`;
            result += `  tournament: ${tournamentId}\n`;
            result += `  match: ${matchId}\n`;
            if (isLikelyUuid) {
                result += `  uuid: true (UUID-Hint)\n`;
            }
            result += `\nIdentifikations-Methode: ${isLikelyUuid ? 'UUID' : 'Numeric ID'}`;

            analysis.innerHTML += `<div class="test-result info">${result}</div>`;
        }

        // Alle Tests ausführen
        async function runAllTests() {
            document.getElementById('testResults').innerHTML = '';
            testUuidGeneration();
            testMatchFinding();
            await testApiIntegration();
        }

        // Demo-Match Tests
        function testUuidMatch() {
            const uuidMatchId = "a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6";
            const url = `/match-page.html?tournament=DEMO&match=${uuidMatchId}&uuid=true`;
            
            if (confirm(`UUID-Match öffnen?\n\nURL: ${url}\n\nÖffnen Sie die Browser-Konsole um die UUID-Verarbeitung zu verfolgen.`)) {
                window.open(url, '_blank');
            }
        }

        function testNumericMatch() {
            const numericMatchId = "123";
            const url = `/match-page.html?tournament=DEMO&match=${numericMatchId}`;
            
            if (confirm(`Numeric-Match öffnen?\n\nURL: ${url}\n\nÖffnen Sie die Browser-Konsole um die ID-Verarbeitung zu verfolgen.`)) {
                window.open(url, '_blank');
            }
        }

        // Performance-Tests
        function benchmarkUuidVsNumeric() {
            const performanceResults = document.getElementById('performanceResults');
            const iterations = 10000;
            
            // UUID-Performance
            const uuidStart = performance.now();
            for (let i = 0; i < iterations; i++) {
                findMatchByIdOrUUID(sampleMatches, "a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6");
            }
            const uuidTime = performance.now() - uuidStart;

            // Numeric-Performance  
            const numericStart = performance.now();
            for (let i = 0; i < iterations; i++) {
                findMatchByIdOrUUID(sampleMatches, "2");
            }
            const numericTime = performance.now() - numericStart;

            let result = `? Performance Benchmark (${iterations} Iterationen):\n\n`;
            result += `UUID-Suche: ${uuidTime.toFixed(2)}ms\n`;
            result += `Numeric-Suche: ${numericTime.toFixed(2)}ms\n`;
            result += `Faktor: ${(uuidTime / numericTime).toFixed(2)}x\n\n`;
            result += `Pro Suche:\n`;
            result += `UUID: ${(uuidTime / iterations * 1000).toFixed(3)}?s\n`;
            result += `Numeric: ${(numericTime / iterations * 1000).toFixed(3)}?s`;

            performanceResults.innerHTML = `<div class="test-result info">${result}</div>`;
        }

        // Hilfsfunktionen
        function generateUuid() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function findMatchByIdOrUUID(matches, searchId) {
            // Priorität 1: UUID-basierte Suche
            const byUuid = matches.find(m => m.uniqueId === searchId);
            if (byUuid) return byUuid;
            
            // Priorität 2: Numerische ID-Suche
            const searchNumeric = parseInt(searchId);
            if (!isNaN(searchNumeric)) {
                const byNumeric = matches.find(m => {
                    const mId = parseInt(m.matchId || m.id);
                    return mId === searchNumeric;
                });
                if (byNumeric) return byNumeric;
            }
            
            return null;
        }

        // Automatischer Test beim Laden
        document.addEventListener('DOMContentLoaded', function() {
            console.log('?? UUID-System Test Page loaded');
            console.log('?? Available test functions:', {
                runAllTests,
                testUuidGeneration,
                testMatchFinding,
                testApiIntegration,
                analyzeMatchId,
                benchmarkUuidVsNumeric
            });
        });
    </script>
</body>
</html>